<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shaoooh - Shiny Hunting Automaton Operating On Original Hardware</title>
  <style>
    :root {
      --falu-red: #7a151b;
      --viridian: #277c5e;
      --celadon: #a0cfa6;
      --sunset: #fbcf9d;
      --bronze: #d48735;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: var(--falu-red);
      color: var(--celadon);
      margin: 0;
      padding: 20px;
    }
    header {
      text-align: center;
      margin-bottom: 10px;
    }
    h1 {
      color: var(--sunset);
    }
    .status-panel {
      background-color: var(--viridian);
      border: 5px solid var(--celadon);
      padding: 20px;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      margin-top: 20px;
    }
    .status-item {
      font-size: 1.2em;
    }
    .controls {
      text-align: center;
      margin-top: 20px;
    }
    .controls button {
      background-color: var(--sunset);
      color: var(--falu-red);
      border: none;
      padding: 10px 20px;
      font-size: 1em;
      border-radius: 5px;
      margin: 0 10px;
      cursor: pointer;
    }
    .controls button:hover {
      background-color: var(--viridian);
      color: var(--celadon);
    }
    .game-output {
      width: 100%;
      max-width: 524px;
      height: 384px;
      background-color: #111;
      border: 5px solid var(--celadon);
      border-radius: 10px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      color: #888;
    }
    .ds-controls {
      border: 5px solid var(--sunset);
      background-color: var(--bronze);
      border-radius: 10px;
      width: fit-content;
      height: fit-content;
    }
    .ds-controls button {
      background-color: var(--sunset);
      color: var(--falu-red);
      border: none;
      padding: 5px 5px;
      font-size: 1em;
      font-weight: bold;
      border-radius: 5px;
      margin: 0 10px;
      cursor: pointer;
      min-width: 70px;
    }
    .ds-controls button:hover {
      background-color: var(--falu-red);
      color: var(--sunset);
    }
    .ds-controls .circle {
      border-radius: 100%;
      width: 80px;
      height: 80px;
    }
    .ds-controls .touch {
      width: 320px;
      height: 240px;
    }
    #n3ds-controls {
      margin-top: 10px;
    }
    .hidden {
      display: none;
    }
    .game-and-control {
      display: flex
    }
    #mode {
      margin: 0px auto;
    }
  </style>
</head>
<body>

  <header>
    <h1>Shaoooh - Shiny Hunting Automaton Operating On Original Hardware</h1>
  </header>

  <div class="status-panel">
    <div class="status-item">Species: <span id="species">Unknown</span></div>
    <div class="status-item">State: <span id="state">Unknown</span></div>
    <div class="status-item">Encounters: <span id="encounters">0</span></div>
  </div>

  <div class="game-and-control">
    <div class="ds-controls">
      <table>
        <tr><td><button onclick="b" value="L">L</button></td><td></td><td></td><td></td><td></td><td></td><td><button onclick="b()" value="R">R</button></td></tr>
        <tr><td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td><button onclick="b()" value="Up">Up</button></td><td></td><td></td><td></td><td><button onclick="b()" value="X">X</button></td><td></td></tr>
        <tr><td><button onclick="b()" value="Left">Left</button></td><td></td><td><button onclick="b()" value="Right">Right</button></td><td></td><td><button onclick="b()" value="Y">Y</button></td><td></td><td><button onclick="b()" value="A">A</button></td></tr>
        <tr><td></td><td><button onclick="b()" value="Down">Down</button></td><td></td><td></td><td></td><td><button onclick="b()" value="B">B</button></td><td></td></tr>
        <tr><td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td><button onclick="b()" value="Start">Start</button></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td><button onclick="b()" value="Select">Select</button></td><td></td><td></td></tr>
      </table>
      <div id="n3ds-controls" class="hidden">
        <table>
          <tr>
            <td><button onclick="b()" value="Home">Home</button></td>
            <td><button id="circle" class="circle" value="Circle">&nbsp;</button></td>
            <td><button id="touch" class="touch" value="Touch">&nbsp;</button></td>
          </tr>
        </table>
      </div>
    </div>

    <div class="game-output" id="gameOutput">
      <img id="gameOutputImage" src="/api/frame" style="width: 512px" />
    </div>
  </div>

  <div class="controls" id="controls">
  </div>

  <div class="controls" id="argument">
    <label for="name">ID</label> <input name="name" id="arg_name" value="Fushigidane" />
    <label for="species">Species</label> <input name="species" id="arg_species" value="1" />
    <label for="game">Game</label> <input name="game" id="arg_game" value="FireRedLeafGreen" />
    <label for="method">Method</label> <input name="method" id="arg_method" value="SoftResetGift" />
    <br /><br />
    <!--<button onclick="frlg_bulba()">FRLG Bulbasaur</button>-->
    <!--<button onclick="frlg_rat()">FRLG Ratatta</button>-->
    <!--<button onclick="lostelle_hypno()">Hypno</button>-->
    <!--<button onclick="usum_legend()">USUM Articuno</button>-->
    <!--<button onclick="usum_entei()">USUM Entei</button>-->
    <!--<button onclick="usum_kyogre()">USUM Kyogre</button>-->
    <!--<button onclick="usum_latias()">USUM Latias</button>-->
    <!--<button onclick="usum_zapdos()">USUM Zapdos</button>-->
    <!--<button onclick="usum_moltres()">USUM Moltres</button>-->
    <!--<button onclick="usum_yveltal()">USUM Yveltal</button>-->
    <!--<button onclick="usum_guzzlord()">USUM Guzzlord</button>-->
    <!--<button onclick="usum_celesteela()">USUM Celesteela</button>-->
    <!--<button onclick="usum_lugia()">USUM Lugia</button>-->
    <!--<button onclick="usum_zekrom()">USUM Zekrom</button>-->
    <!--<button onclick="usum_cresselia()">USUM Cresselia</button>-->
    <!--<button onclick="usum_mewtwo()">USUM Mewtwo</button>-->
    <!--<button onclick="usum_poipole()">USUM Poipole</button>-->
    <button onclick="usum_minior()">USUM Minior</button>
    <button onclick="rs_beldum()">Beldum</button>
    <!--<button onclick="dp_giratina()">DP Giratina</button>-->
    <!--<button onclick="hgss_dunsparse()">Three Segment</button>-->
    <button onclick="frlg_snorlax()">FRLG Snorlax</button>
    <button onclick="hgss_start()">HGSS Starter</button>
    <!--<button onclick="frlg_omanyte()">FRLG Omanyte</button>-->
    <!--<button onclick="frlg_lapras()">FRLG Lapras</button>-->
    <!--<button onclick="frlg_eevee()">FRLG Eevee</button>-->
    <!--<button onclick="frlg_vulpix()">FRLG Vulpix</button>-->
    <!--<button onclick="frlg_sandshrew()">FRLG Sandshrew</button>-->
    <button onclick="frlg_caterpie()">FRLG Caterpie</button>
    <!--<button onclick="dp_shinx()">DP Cute Charm Shinx</button>-->
    <!--<button onclick="rs_oddish()">RS Oddish</button>-->
    <!--<button onclick="frlg_egg()">FRLG Eggs</button>-->
    <!--<button onclick="hgss_rat()">HGSS Ratatta</button>-->
    <!--<button onclick="hgss_ditto()">HGSS Ditto</button>-->
    <!--<button onclick="rs_registeel()">RS Registeel</button>-->
    <!--<button onclick="bw2_latios()">BW2 Latios</button>-->
    <button onclick="usum_blacephalon()">USUM Blacephalon</button>
    <button onclick="usum_money()">Utility - Money</button>
    <button onclick="usum_catch()">Utility - Catch</button>
  </div>

  <div class="status-panel">
    <div id="mode" class="status-item">Current Configuration</div>
  </div>


  <img id="dummy" style="display: none" />
  <script>
    var extended = false;
    var ext_count = 0;
    var last_blob1 = "";
    var last_blob2 = "";
    let state = "/api/state";
    let button = "/api/button";

    function current_hunt() {
      usum_blacephalon();
    }
    function lostelle_hypno() {
      document.getElementById("arg_name").value = "LostelleHypno";
      document.getElementById("arg_species").value = "97";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function frlg_omanyte() {
      document.getElementById("arg_name").value = "Omanyte";
      document.getElementById("arg_species").value = "138";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "SoftResetGift";
    }
    function frlg_lapras() {
      document.getElementById("arg_name").value = "SilphLapras";
      document.getElementById("arg_species").value = "131";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "SoftResetGift";
    }
    function frlg_eevee() {
      document.getElementById("arg_name").value = "Eevee";
      document.getElementById("arg_species").value = "133";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "SoftResetGift";
    }
    function frlg_vulpix() {
      document.getElementById("arg_name").value = "Vulpix";
      document.getElementById("arg_species").value = "37";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "RandomEncounter";
    }
    function frlg_sandshrew() {
      document.getElementById("arg_name").value = "Sandshrew";
      document.getElementById("arg_species").value = "27";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "RandomEncounter";
    }
    function frlg_caterpie() {
      document.getElementById("arg_name").value = "Caterpie";
      document.getElementById("arg_species").value = "10";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "RandomEncounter";
    }
    function rs_beldum() {
      document.getElementById("arg_name").value = "StevenBeldum";
      document.getElementById("arg_species").value = "374";
      document.getElementById("arg_game").value = "RubySapphire";
      document.getElementById("arg_method").value = "SoftResetGift";
    }
    function usum_legend() {
      document.getElementById("arg_name").value = "WormholeArticuno";
      document.getElementById("arg_species").value = "144";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_zapdos() {
      document.getElementById("arg_name").value = "WormholeZapdos";
      document.getElementById("arg_species").value = "145";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_moltres() {
      document.getElementById("arg_name").value = "WormholeMoltres";
      document.getElementById("arg_species").value = "146";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_yveltal() {
      document.getElementById("arg_name").value = "WormholeYveltal";
      document.getElementById("arg_species").value = "717";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_guzzlord() {
      document.getElementById("arg_name").value = "WormholeGuzzlord";
      document.getElementById("arg_species").value = "799";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_celesteela() {
      document.getElementById("arg_name").value = "WormholeCelesteela";
      document.getElementById("arg_species").value = "797";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_lugia() {
      document.getElementById("arg_name").value = "WormholeLugia";
      document.getElementById("arg_species").value = "249";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_zekrom() {
      document.getElementById("arg_name").value = "WormholeZekrom";
      document.getElementById("arg_species").value = "644";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_cresselia() {
      document.getElementById("arg_name").value = "WormholeCresselia";
      document.getElementById("arg_species").value = "488";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_mewtwo() {
      document.getElementById("arg_name").value = "WormholeMewtwo";
      document.getElementById("arg_species").value = "150";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_poipole() {
      document.getElementById("arg_name").value = "UBAdhesive";
      document.getElementById("arg_species").value = "803";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetGift";
    }
    function usum_blacephalon() {
      document.getElementById("arg_name").value = "UBBurst";
      document.getElementById("arg_species").value = "806";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_minior() {
      document.getElementById("arg_name").value = "Minior";
      document.getElementById("arg_species").value = "774";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "RandomEncounter";
    }
    function usum_entei() {
      document.getElementById("arg_name").value = "WormholeEntei";
      document.getElementById("arg_species").value = "244";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_kyogre() {
      document.getElementById("arg_name").value = "WormholeKyogre";
      document.getElementById("arg_species").value = "382";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_latias() {
      document.getElementById("arg_name").value = "WormholeLatias";
      document.getElementById("arg_species").value = "380";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function hgss_dunsparse() {
      document.getElementById("arg_name").value = "ThreeSegment";
      document.getElementById("arg_species").value = "206";
      document.getElementById("arg_game").value = "HeartGoldSoulSilver";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function dp_giratina() {
      document.getElementById("arg_name").value = "Giratina";
      document.getElementById("arg_species").value = "487";
      document.getElementById("arg_game").value = "DiamondPearl";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function dp_regi() {
      document.getElementById("arg_name").value = "Regigigas";
      document.getElementById("arg_species").value = "486";
      document.getElementById("arg_game").value = "DiamondPearl";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function frlg_snorlax() {
      document.getElementById("arg_name").value = "KantoSnorlax";
      document.getElementById("arg_species").value = "143";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function hgss_start() {
      document.getElementById("arg_name").value = "FireStarterHGSS";
      document.getElementById("arg_species").value = "155";
      document.getElementById("arg_game").value = "HeartGoldSoulSilver";
      document.getElementById("arg_method").value = "SoftResetGift";
    }
    function frlg_bulba() {
      document.getElementById("arg_name").value = "Fushigidane";
      document.getElementById("arg_species").value = "1";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "SoftResetGift";
    }
    function frlg_rat() {
      document.getElementById("arg_name").value = "Hazel";
      document.getElementById("arg_species").value = "19";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "RandomEncounter";
    }
    function dp_shinx() {
      document.getElementById("arg_name").value = "YellowShinx";
      document.getElementById("arg_species").value = "403";
      document.getElementById("arg_game").value = "DiamondPearl";
      document.getElementById("arg_method").value = "RandomEncounter";
    }
    function rs_oddish() {
      document.getElementById("arg_name").value = "SafariWeek";
      document.getElementById("arg_species").value = "43";
      document.getElementById("arg_game").value = "RubySapphire";
      document.getElementById("arg_method").value = "SafariZone";
    }
    function rs_registeel() {
      document.getElementById("arg_name").value = "Registeel";
      document.getElementById("arg_species").value = "379";
      document.getElementById("arg_game").value = "RubySapphire";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function frlg_egg() {
      document.getElementById("arg_name").value = "SafariWeekFRLG";
      document.getElementById("arg_species").value = "102";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "SafariZone";
    }
    function hgss_rat() {
      document.getElementById("arg_name").value = "SafariWeekHGSS";
      document.getElementById("arg_species").value = "19";
      document.getElementById("arg_game").value = "HeartGoldSoulSilver";
      document.getElementById("arg_method").value = "SafariZone";
    }
    function hgss_ditto() {
      document.getElementById("arg_name").value = "DittoHGSS";
      document.getElementById("arg_species").value = "132";
      document.getElementById("arg_game").value = "HeartGoldSoulSilver";
      document.getElementById("arg_method").value = "RandomEncounter";
    }
    function bw2_latios() {
      document.getElementById("arg_name").value = "DreamLatios";
      document.getElementById("arg_species").value = "381";
      document.getElementById("arg_game").value = "Black2White2";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function usum_money() {
      document.getElementById("arg_name").value = "ORASMoney";
      document.getElementById("arg_species").value = "1";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "Utility";
    }
    function usum_catch() {
      document.getElementById("arg_name").value = "ORASCatch";
      document.getElementById("arg_species").value = "2";
      document.getElementById("arg_game").value = "UltraSunUltraMoon";
      document.getElementById("arg_method").value = "Utility";
    }


    function b() {
      fetch(button, {
        method: "POST",
        body: JSON.stringify(window.event.target.value),
        headers: {
          "Content-Type": "application/json",
        }
      })
      .catch(err => console.log(err));
    }

    function b2(e) {
      let control = {};
      let x = e.offsetX;
      let y = e.offsetY;
      if (e.target.value == "Circle") {
        y = 80 - y;
        x = (x * 255) / 80;
        y = (y * 255) / 80;
      }
      x = Math.round(x);
      y = Math.round(y);
      control[e.target.value] = [x, y];
      let ctrl_str = JSON.stringify(control);
      fetch(button, {
        method: "POST",
        body: ctrl_str,
        headers: {
          "Content-Type": "application/json",
        }
      })
      .catch(err => console.log(err));
    }

    function stateButton(e) {
      var transition = e.target.value;
      var needsArg = e.target.dataset.needsArg == "true";
      var argument = null;
      console.log(transition);

      if (needsArg) {
        argument = {
          name: document.getElementById("arg_name").value,
          species: parseInt(document.getElementById("arg_species").value),
          game: document.getElementById("arg_game").value,
          method: document.getElementById("arg_method").value
        };
      }

      var request = {
        transition: transition,
        arg: argument
      };

      fetch(state, {
        method: "POST",
        body: JSON.stringify(request),
        headers: {
          "Content-Type": "application/json",
        }
      })
      .catch(err => console.log(err));
    }

    function buildControls(transitions) {
      var controls = document.getElementById("controls");
      controls.innerHTML = "";

      transitions.forEach(element => {
        var b = document.createElement("button");
        b.onclick = stateButton;
        b.innerText = element.transition;
        b.value = element.transition;
        b.dataset.needsArg = element.needs_arg;
        controls.appendChild(b);
      });
    }

    var errorCount = 0;

    window.stateTimer = 1000;
    window.frameTimer = 250;

    function updateFrame() {
      fetch("/api/frame")
        .then(res => res.blob())
        .then(blob => {
          var url = URL.createObjectURL(blob);
          var img = document.getElementById("gameOutputImage");
          img.src = url;
          setTimeout(updateFrame, window.frameTimer);
          URL.revokeObjectURL(last_blob1);
          last_blob1 = url;
        })
        .catch(err => {
          errorCount++;
          if (errorCount < 10) {
            setTimeout(updateFrame, window.frameTimer)
          }
          console.log(err);
        });
      ext_count++;
      if (extended && ext_count % 4 == 0) {
        fetch("/api/frame2")
        .then(res => res.blob())
        .then(blob => {
          var url = URL.createObjectURL(blob);
          var pre = document.getElementById("dummy");
          pre.src = url;
          var img = document.getElementById("touch");
          img.style.background = "url("+url+")";
          URL.revokeObjectURL(last_blob2);
          last_blob2 = url;
        })
        .catch(err => {
          console.log(err);
        });
      }
    }

    function updateState() {
      fetch(state)
        .then(res => res.json())
        .then(out => {
          document.getElementById("state").innerHTML = out.state.state;
          if (out.state.arg === null) {
            document.getElementById("species").innerHTML = "";
          } else {
            document.getElementById("species").innerHTML = out.state.arg.species;
          }
          document.getElementById("encounters").innerHTML = out.state.encounters;
          buildControls(out.transitions);
          errorCount = 0;
          setTimeout(updateState, window.stateTimer)
        })
        .catch(err => {
          errorCount++;
          if (errorCount < 10) {
            setTimeout(updateState, window.stateTimer)
          }
          console.log(err);
        });
    }

    function updateMode() {
      fetch("/api/mode")
        .then(res => res.json())
        .then(json => {
          if (json.extended) {
            extended = true;
            document.getElementById("n3ds-controls").className = "";
            document.getElementById("circle").addEventListener("click", b2);
            document.getElementById("touch").addEventListener("click", b2);
          }
          document.getElementById("mode").innerHTML = json.info + " " + json.emoji + " " + json.description;
        })
        .catch(err => {
          console.log(err);
        });
    }

    window.onload = function() {
      current_hunt();
      updateMode();
      updateState();
      updateFrame();
    }
  </script>

</body>
</html>
