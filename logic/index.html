<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shaoooh - Shiny Hunting Automaton Operating On Original Hardware</title>
  <style>
    :root {
      --falu-red: #7a151b;
      --viridian: #277c5e;
      --celadon: #a0cfa6;
      --sunset: #fbcf9d;
      --bronze: #d48735;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: var(--falu-red);
      color: var(--celadon);
      margin: 0;
      padding: 20px;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    h1 {
      color: var(--sunset);
    }
    .status-panel {
      background-color: var(--viridian);
      border: 5px solid var(--celadon);
      padding: 20px;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .status-item {
      font-size: 1.2em;
    }
    .controls {
      text-align: center;
      margin-top: 20px;
    }
    .controls button {
      background-color: var(--sunset);
      color: var(--falu-red);
      border: none;
      padding: 10px 20px;
      font-size: 1em;
      border-radius: 5px;
      margin: 0 10px;
      cursor: pointer;
    }
    .controls button:hover {
      background-color: var(--viridian);
      color: var(--celadon);
    }
    .game-output {
      width: 100%;
      max-width: 524px;
      height: 384px;
      background-color: #111;
      border: 5px solid var(--celadon);
      border-radius: 10px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      color: #888;
    }
    .ds-controls {
      border: 5px solid var(--sunset);
      background-color: var(--bronze);
      border-radius: 10px;
      width: fit-content;
      height: fit-content;
    }
    .ds-controls button {
      background-color: var(--sunset);
      color: var(--falu-red);
      border: none;
      padding: 5px 5px;
      font-size: 1em;
      font-weight: bold;
      border-radius: 5px;
      margin: 0 10px;
      cursor: pointer;
      min-width: 70px;
    }
    .ds-controls button:hover {
      background-color: var(--falu-red);
      color: var(--sunset);
    }
    .game-and-control {
      display: flex
    }
  </style>
</head>
<body>

  <header>
    <h1>Shaoooh - Shiny Hunting Automaton Operating On Original Hardware</h1>
  </header>

  <div class="status-panel">
    <div class="status-item">Species: <span id="species">Unknown</span></div>
    <div class="status-item">State: <span id="state">Unknown</span></div>
    <div class="status-item">Encounters: <span id="encounters">0</span></div>
  </div>

  <div class="game-and-control">
    <div class="ds-controls">
      <table>
        <tr><td><button onclick="b" value="L">L</button></td><td></td><td></td><td></td><td></td><td></td><td><button onclick="b()" value="R">R</button></td></tr>
        <tr><td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td><button onclick="b()" value="Up">Up</button></td><td></td><td></td><td></td><td><button onclick="b()" value="X">X</button></td><td></td></tr>
        <tr><td><button onclick="b()" value="Left">Left</button></td><td></td><td><button onclick="b()" value="Right">Right</button></td><td></td><td><button onclick="b()" value="Y">Y</button></td><td></td><td><button onclick="b()" value="A">A</button></td></tr>
        <tr><td></td><td><button onclick="b()" value="Down">Down</button></td><td></td><td></td><td></td><td><button onclick="b()" value="B">B</button></td><td></td></tr>
        <tr><td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td><button onclick="b()" value="Start">Start</button></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td><button onclick="b()" value="Select">Select</button></td><td></td><td></td></tr>
      </table>
    </div>

    <div class="game-output" id="gameOutput">
      <img id="gameOutputImage" src="/api/frame" style="width: 512px" />
    </div>
  </div>

  <div class="controls" id="controls">
  </div>

  <div class="controls" id="argument">
    <label for="name">ID</label> <input name="name" id="arg_name" value="Fushigidane" />
    <label for="species">Species</label> <input name="species" id="arg_species" value="1" />
    <label for="game">Game</label> <input name="game" id="arg_game" value="FireRedLeafGreen" />
    <label for="method">Method</label> <input name="method" id="arg_method" value="SoftResetGift" />
    <br /><br />
    <!--<button onclick="frlg_bulba()">FRLG Bulbasaur</button>-->
    <!--<button onclick="frlg_rat()">FRLG Ratatta</button>-->
    <button onclick="dp_giratina()">DP Giratina</button>
    <button onclick="frlg_snorlax()">FRLG Snorlax</button>
    <button onclick="hgss_start()">HGSS Starter</button>
    <!--<button onclick="dp_shinx()">DP Cute Charm Shinx</button>-->
    <!--<button onclick="rs_oddish()">RS Oddish</button>-->
    <button onclick="frlg_egg()">FRLG Eggs</button>
    <button onclick="hgss_rat()">HGSS Ratatta</button>
    <!--<button onclick="hgss_ditto()">HGSS Ditto</button>-->
    <!--<button onclick="rs_registeel()">RS Registeel</button>-->
    <!--<button onclick="bw2_latios()">BW2 Latios</button>-->
  </div>

  <script>
    let state = "/api/state";
    let button = "/api/button";

    function dp_giratina() {
      document.getElementById("arg_name").value = "Giratina";
      document.getElementById("arg_species").value = "487";
      document.getElementById("arg_game").value = "DiamondPearl";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function dp_regi() {
      document.getElementById("arg_name").value = "Regigigas";
      document.getElementById("arg_species").value = "486";
      document.getElementById("arg_game").value = "DiamondPearl";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function frlg_snorlax() {
      document.getElementById("arg_name").value = "KantoSnorlax";
      document.getElementById("arg_species").value = "143";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function hgss_start() {
      document.getElementById("arg_name").value = "FireStarterHGSS";
      document.getElementById("arg_species").value = "155";
      document.getElementById("arg_game").value = "HeartGoldSoulSilver";
      document.getElementById("arg_method").value = "SoftResetGift";
    }
    function frlg_bulba() {
      document.getElementById("arg_name").value = "Fushigidane";
      document.getElementById("arg_species").value = "1";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "SoftResetGift";
    }
    function frlg_rat() {
      document.getElementById("arg_name").value = "Hazel";
      document.getElementById("arg_species").value = "19";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "RandomEncounter";
    }
    function dp_shinx() {
      document.getElementById("arg_name").value = "YellowShinx";
      document.getElementById("arg_species").value = "403";
      document.getElementById("arg_game").value = "DiamondPearl";
      document.getElementById("arg_method").value = "RandomEncounter";
    }
    function rs_oddish() {
      document.getElementById("arg_name").value = "SafariWeek";
      document.getElementById("arg_species").value = "43";
      document.getElementById("arg_game").value = "RubySapphire";
      document.getElementById("arg_method").value = "SafariZone";
    }
    function rs_registeel() {
      document.getElementById("arg_name").value = "Registeel";
      document.getElementById("arg_species").value = "379";
      document.getElementById("arg_game").value = "RubySapphire";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }
    function frlg_egg() {
      document.getElementById("arg_name").value = "SafariWeekFRLG";
      document.getElementById("arg_species").value = "102";
      document.getElementById("arg_game").value = "FireRedLeafGreen";
      document.getElementById("arg_method").value = "SafariZone";
    }
    function hgss_rat() {
      document.getElementById("arg_name").value = "SafariWeekHGSS";
      document.getElementById("arg_species").value = "19";
      document.getElementById("arg_game").value = "HeartGoldSoulSilver";
      document.getElementById("arg_method").value = "SafariZone";
    }
    function hgss_ditto() {
      document.getElementById("arg_name").value = "DittoHGSS";
      document.getElementById("arg_species").value = "132";
      document.getElementById("arg_game").value = "HeartGoldSoulSilver";
      document.getElementById("arg_method").value = "RandomEncounter";
    }
    function bw2_latios() {
      document.getElementById("arg_name").value = "DreamLatios";
      document.getElementById("arg_species").value = "381";
      document.getElementById("arg_game").value = "Black2White2";
      document.getElementById("arg_method").value = "SoftResetEncounter";
    }

    function b() {
      fetch(button, {
        method: "POST",
        body: JSON.stringify(window.event.target.value),
        headers: {
          "Content-Type": "application/json",
        }
      })
      .catch(err => console.log(err));
    }

    function stateButton(e) {
      var transition = e.target.value;
      var needsArg = e.target.dataset.needsArg == "true";
      var argument = null;
      console.log(transition);

      if (needsArg) {
        argument = {
          name: document.getElementById("arg_name").value,
          species: parseInt(document.getElementById("arg_species").value),
          game: document.getElementById("arg_game").value,
          method: document.getElementById("arg_method").value
        };
      }

      var request = {
        transition: transition,
        arg: argument
      };

      fetch(state, {
        method: "POST",
        body: JSON.stringify(request),
        headers: {
          "Content-Type": "application/json",
        }
      })
      .catch(err => console.log(err));
    }

    function buildControls(transitions) {
      var controls = document.getElementById("controls");
      controls.innerHTML = "";

      transitions.forEach(element => {
        var b = document.createElement("button");
        b.onclick = stateButton;
        b.innerText = element.transition;
        b.value = element.transition;
        b.dataset.needsArg = element.needs_arg;
        controls.appendChild(b);
      });
    }

    var errorCount = 0;

    window.stateTimer = 1000;
    window.frameTimer = 250;

    function updateFrame() {
      fetch("/api/frame")
        .then(res => res.blob())
        .then(blob => {
          var img = document.getElementById("gameOutputImage");
          img.src = URL.createObjectURL(blob);
          setTimeout(updateFrame, window.frameTimer);
        })
        .catch(err => {
          errorCount++;
          if (errorCount < 10) {
            setTimeout(updateFrame, window.frameTimer)
          }
          console.log(err);
        });
    }

    function updateState() {
      fetch(state)
        .then(res => res.json())
        .then(out => {
          document.getElementById("state").innerHTML = out.state.state;
          if (out.state.arg === null) {
            document.getElementById("species").innerHTML = "";
          } else {
            document.getElementById("species").innerHTML = out.state.arg.species;
          }
          document.getElementById("encounters").innerHTML = out.state.encounters;
          buildControls(out.transitions);
          errorCount = 0;
          setTimeout(updateState, window.stateTimer)
        })
        .catch(err => {
          errorCount++;
          if (errorCount < 10) {
            setTimeout(updateState, window.stateTimer)
          }
          console.log(err);
        });
    }

    window.onload = function() {
      updateState();
      updateFrame();
    }
  </script>

</body>
</html>
